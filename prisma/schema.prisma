generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model budgets {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String        @db.Uuid
  category_id String        @db.Uuid
  amount      Decimal       @db.Decimal(14, 2)
  period      budget_period
  start_date  DateTime      @db.Date
  end_date    DateTime      @db.Date
  created_at  DateTime      @default(now()) @db.Timestamptz(6)
  updated_at  DateTime      @default(now()) @db.Timestamptz(6)
  categories  categories    @relation(fields: [category_id], references: [id], onUpdate: NoAction)
  users       users         @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, category_id, start_date, end_date], map: "uq_budget_window")
  @@index([user_id, start_date, end_date], map: "idx_budgets_user_window")
}

model categories {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String            @db.Uuid
  name            String
  type            transaction_type
  color           String
  icon            String
  created_at      DateTime          @default(now()) @db.Timestamptz(6)
  updated_at      DateTime          @default(now()) @db.Timestamptz(6)
  budgets         budgets[]
  calendar_events calendar_events[]
  users           users             @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  goals           goals[]
  transactions    transactions[]

  @@unique([user_id, name, type], map: "uq_categories_user_name_type")
  @@index([user_id, type], map: "idx_categories_user_type")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model goals {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id        String      @db.Uuid
  title          String
  description    String?
  target_amount  Decimal     @db.Decimal(14, 2)
  current_amount Decimal     @default(0) @db.Decimal(14, 2)
  target_date    DateTime    @db.Date
  category_id    String?     @db.Uuid
  status         goal_status @default(active)
  created_at     DateTime    @default(now()) @db.Timestamptz(6)
  updated_at     DateTime    @default(now()) @db.Timestamptz(6)
  categories     categories? @relation(fields: [category_id], references: [id], onUpdate: NoAction)
  users          users       @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id, status], map: "idx_goals_user_status")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model transactions {
  id          String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String           @db.Uuid
  category_id String           @db.Uuid
  type        transaction_type
  amount      Decimal          @db.Decimal(14, 2)
  description String
  occurred_on DateTime         @db.Date
  created_at  DateTime         @default(now()) @db.Timestamptz(6)
  updated_at  DateTime         @default(now()) @db.Timestamptz(6)
  categories  categories       @relation(fields: [category_id], references: [id], onUpdate: NoAction)
  users       users            @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([category_id], map: "idx_transactions_category")
  @@index([user_id, occurred_on], map: "idx_transactions_user_date")
  @@index([user_id, type], map: "idx_transactions_user_type")
}

model users {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String
  email           String            @unique
  currency        String            @default("RUB")
  initial_balance Decimal           @default(0) @db.Decimal(14, 2)
  created_at      DateTime          @default(now()) @db.Timestamptz(6)
  updated_at      DateTime          @default(now()) @db.Timestamptz(6)
  password_hash   String            @default("")
  budgets         budgets[]
  calendar_events calendar_events[]
  categories      categories[]
  goals           goals[]
  transactions    transactions[]
}

model calendar_events {
  id           String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String           @db.Uuid
  category_id  String           @db.Uuid
  title        String
  description  String?
  amount       Decimal          @db.Decimal(14, 2)
  event_date   DateTime         @db.Date
  recurrence   recurrence_type?
  is_completed Boolean          @default(false)
  created_at   DateTime         @default(now()) @db.Timestamptz(6)
  updated_at   DateTime         @default(now()) @db.Timestamptz(6)
  categories   categories       @relation(fields: [category_id], references: [id], onUpdate: NoAction)
  users        users            @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id, event_date], map: "idx_calendar_events_user_date")
  @@index([user_id, is_completed], map: "idx_calendar_events_user_completed")
}

enum budget_period {
  monthly
  yearly
}

enum goal_status {
  active
  completed
  paused
}

enum transaction_type {
  income
  expense
}

enum recurrence_type {
  none
  daily
  weekly
  monthly
  yearly
}
